export MALLOC_CHECK_=0 # workaround for LP: #520465
export LC_ALL=C
export DEBIAN_FRONTEND=noninteractive

mount -t proc proc kali-$architecture/proc
mount -o bind /dev/ kali-$architecture/dev/
mount -o bind /dev/pts kali-$architecture/dev/pts

# Copy necessary scripts and make executable (/dev/null to supress error msgs for following symlinks)
cp -rf fs/* kali-$architecture/
LANG=C chroot kali-$architecture chmod 755 /usr/bin/* 2> /dev/null
LANG=C chroot kali-$architecture chmod 755 /usr/share/mana-toolkit/run-mana/*.sh 2> /dev/null

cat << EOF > kali-$architecture/debconf.set
console-common console-data/keymap/policy select Select keymap from full list
console-common console-data/keymap/full select en-latin1-nodeadkeys
EOF

cat << EOF > kali-$architecture/third-stage
#!/bin/bash
dpkg-divert --add --local --divert /usr/sbin/invoke-rc.d.chroot --rename /usr/sbin/invoke-rc.d
cp /bin/true /usr/sbin/invoke-rc.d
echo -e "#!/bin/sh\nexit 101" > /usr/sbin/policy-rc.d
chmod +x /usr/sbin/policy-rc.d

apt-get clean
rm -rf /var/lib/apt/lists/*  
apt-get clean
safe-apt-get update
safe-apt-get install locales-all

debconf-set-selections /debconf.set
rm -f /debconf.set
safe-apt-get update
safe-apt-get -y install git-core binutils ca-certificates initramfs-tools
safe-apt-get -y install locales console-common less nano git
echo "root:toor" | chpasswd
sed -i -e 's/KERNEL\!=\"eth\*|/KERNEL\!=\"/' /lib/udev/rules.d/75-persistent-net-generator.rules
rm -f /etc/udev/rules.d/70-persistent-net.rules
safe-apt-get --yes --force-yes install $packages

rm -f /usr/sbin/policy-rc.d
rm -f /usr/sbin/invoke-rc.d
dpkg-divert --remove --rename /usr/sbin/invoke-rc.d

rm -f /third-stage
EOF

chmod +x kali-$architecture/third-stage
LANG=C chroot kali-$architecture /third-stage

# Modify Kismet log saving folder
sed -i 's/hs/\/captures/g' kali-$architecture/etc/kismet/kismet.conf

cat << 'EOF' > kali-$architecture/usr/bin/dumpmifare.sh
#!/bin/bash
mfoc -O /root/mifare-dump-$(date +"%Y%m%d_%H%M%S")
EOF


# Modify SSHD to allow password logins which is a security risk 
# if the user doesn't change their password
# or change their configuration for key based ssh
sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' kali-$architecture/etc/ssh/sshd_config

# Install dictionary
mkdir -p kali-$architecture/opt/dic
tar xvf dictionary/89.tar.gz -C kali-$architecture/opt/dic
cp dictionary/wordlist.txt kali-$architecture/opt/dic/wordlist.txt
cp dictionary/pinlist.txt kali-$architecture/opt/dic/pinlist.txt

# Install Pingen which generates DLINK WPS pins for some routers
wget https://raw.githubusercontent.com/devttys0/wps/master/pingens/dlink/pingen.py -O kali-$architecture/usr/bin/pingen

#Installs APFucker.py
curl -o kali-$architecture/usr/bin/apfucker.py https://raw.githubusercontent.com/mattoufoutu/scripts/master/AP-Fucker.py

# Install MPC by g0tmilk
wget https://raw.githubusercontent.com/g0tmi1k/mpc/master/mpc.sh -O kali-$architecture/usr/bin/mpc

# Install Spiderfoot
# Cherrypy is newer in pip then in repo so we need to use that instead.  All other depend are fine.
LANG=C chroot kali-$architecture pip install cherrypy
wget https://github.com/smicallef/spiderfoot/archive/v2.5.1-final.tar.gz -O kali-$architecture/opt/spiderfoot.tar.gz
tar xvf kali-$architecture/opt/spiderfoot.tar.gz -C kali-$architecture/opt
rm kali-$architecture/opt/spiderfoot.tar.gz
mv kali-$architecture/opt/spiderfoot-* kali-$architecture/opt/spiderfoot

# Sets the default for hostapd.conf to the mana karma version
sed -i 's#^DAEMON_CONF=.*#DAEMON_CONF=/etc/mana-toolkit/hostapd-karma.conf#' kali-$architecture/etc/init.d/hostapd
sed -i 's/wlan0/wlan1/g' kali-$architecture/etc/mana-toolkit/hostapd-karma.conf

# DNSMASQ Configuration options for optional access point
cat <<EOF > kali-$architecture/etc/dnsmasq.conf
log-facility=/var/log/dnsmasq.log
#address=/#/10.0.0.1
#address=/google.com/10.0.0.1
interface=wlan1
dhcp-range=10.0.0.10,10.0.0.250,12h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
#no-resolv
log-queries
EOF

# In order for metasploit to work daemon,nginx,postgres must all be added to inet
# beef-xss creates user beef-xss. Openvpn server requires nobdy:nobody in order to work
echo "inet:x:3004:postgres,root,beef-xss,daemon,nginx,mysql" >> kali-$architecture/etc/group
echo "nobody:x:3004:nobody" >> kali-$architecture/etc/group
